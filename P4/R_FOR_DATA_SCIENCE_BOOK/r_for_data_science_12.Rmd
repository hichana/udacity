---
title: "r_for_data_science_12"
author: "Matt Chana"
date: "6/10/2017"
output: html_document
---

```{r}
library(tidyverse)
```

### 12.2 Tidy data

Each:

* variable has its own column
* observation has its own row
* value has its own cell

Practical instructions:

Put each:
1. dataset in a tibble
2. variable in a column

Vectorized operations easy across tidy data.

Example of tidy data set:
```{r}
table1
```

Example mutate:
```{r}
# compute rate per 10,000
table1 %>%
  mutate(rate = cases / population * 10000)
```

Example count:
```{r}
# compute cases per year
table1 %>%
  count(year, wt = cases)
```

Visualize changes over time:
```{r}
ggplot(table1, aes(year,cases)) +
  geom_line(aes(group = country), color = "grey50") +
  geom_point(aes(color = country))
```

### 12.3.1 Gathering
For example, table has values as column names that represent an observation:
```{r}
table4a
```

To tidy, need to `gather()` some columns into new pair of variables. Describe the operation:

* columns to be gathered: `1999` and `2000`
* name of column to represent the column names represented as values (`key`): will use `year`
* value from either column corresponding to each column name turned value (`value`): will use `cases`

```{r}
# note back-ticks ` surround gathered columns b/c non syntactic (dplyr::select() style notation)
table4a %>% 
  gather(`1999`, `2000`, key = "year", value = "cases")
```

Perform a left join ot two gathered tables:
```{r}
tidy4a <- table4a %>%
  gather(`1999`, `2000`, key = "year", value = "cases")
tidy4b <- table4b %>%
  gather(`1999`, `2000`, key = "year", value = "population")
left_join(tidy4a, tidy4b)
```

### 12.3.2 Spreading
Used when an observation is scattered across multiple rows. Example:
```{r}
table2
```

See how each observation has multiple rows by transposing:
```{r}
glimpse(table2)
```


Analyze what needs to happen:

* The `key` (what should be spread to a single observation) here is `type`
* the `value` (values to represent the items in `key`) here is `count`

```{r}
spread(table2, key = type, value = count)
```

Note, `gather()` makes wide tables narrower and longer, while `spread()` makes tables shorter and wider.

### 12.4.1 Separate
When a variable has multiple values in one. Example (`rate` contains `cases`/`population`):
```{r}
table3
```

Split by a separator (defaults to where non alpha-numeric character:
```{r}
table3 %>%
  separate(rate, into = c("cases", "population"))
```

Specify where to split:
```{r}
table3 %>%
  separate(rate, into = c("cases", "population"), sep = "/")
```

Note, `sep = ` is formally a regular expression. Also, `cases` and `population` columns are now character type as default of `separate()`. Can ask `separate()` to convert though:
```{r}
table3 %>%
  separate(rate, into = c("cases", "population"), convert = TRUE)
```

Pass vector of ints into `sep` (example makes data less tidy but as example good):
```{r}
table3 %>%
  separate(year, into = c("century", "year"), sep = 2)
```

### 12.4.2 Unite
Combine multiple columns into single column. Untidy example:
```{r}
table5
```

```{r}
table5 %>%
  unite(new, century, year)
```

But default `sep` is '_'. So to specify:
```{r}
table5 %>%
  unite(new, century, year, sep = "")
```

### 12.5 Missing values
Two types of missing values:

* Explicit (respresented by `NA`)
* Implicit (ex. a year skipped `2014`, `2015`, `2017`)

Example with both:
```{r}
stocks <- tibble(
  year   = c(2015, 2015, 2015, 2015, 2016, 2016, 2016),
  qtr    = c(   1,    2,    3,    4,    2,    3,    4),
  return = c(1.88, 0.59, 0.35,   NA, 0.92, 0.17, 2.66)
)
stocks
```

Notice 1st quarter of 2016 data missing.

Make implicit value explicit with `spread()`:
```{r}
stocks %>%
  spread(year, return)
```

Make explicit missing values implicit (so now the row they represent will be missing):
```{r}
stocks %>%
  spread(year, return) %>%
  gather(year, return, `2015`:`2016`, na.rm = TRUE)
```

Use `complete()` to make missing values explicit (makes sets among variables then assures uniformity when filling in NA):
```{r}
stocks %>%
  complete(year, qtr)
```

When missing value indicates that previous values should have been carried forward. Example:
```{r}
treatment <- tribble(
  ~ person,           ~ treatment, ~response,
  "Derrick Whitmore", 1,           7,
  NA,                 2,           10,
  NA,                 3,           9,
  "Katherine Burke",  1,           4
)
treatment
```

Use `fill()` to replace subsequent values with the most recent one:
```{r}
treatment %>%
  fill(person)
```






